name: Tests

on:
  workflow_call:
    inputs:
      python:
        required: true
        type: string
      args:
        required: false
        type: string

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
      - name: Install dependencies
        run: |
          curl -sSL https://pdm-project.org/install-pdm.py | python3 -
          pip install tox tox-pdm
      - name: Run unit tests
        run: tox -e test-unit -- ${{ inputs.args }}

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
      - name: Install dependencies
        run: |
          curl -sSL https://pdm-project.org/install-pdm.py | python3 -
          pip install tox tox-pdm
      - name: Run integration tests
        run: tox -e test-integration -- ${{ inputs.args }}

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Cache the binary artifact
      # The key is based on the runner's OS and the hash of the Dockerfile.
      # If the Dockerfile changes, the hash changes, and a new cache is created.
      - name: Cache vLLM-sim binary
        id: cache-vllm-sim
        uses: actions/cache@v4
        with:
          # The path to the file you want to cache
          path: bin/llm-d-inference-sim
          # The unique key for the cache
          key: vllm-sim-binary-${{ runner.os }}-${{ hashFiles('tests/e2e/vllm-sim.Dockerfile') }}
      # Set up Docker Buildx (required for the 'docker build -o' command)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # Conditionally build the artifact
      # This step only runs if the cache step above did NOT find a match.
      # 'steps.cache-vllm-sim.outputs.cache-hit' will be 'true' if the cache was restored.
      - name: Build vLLM-sim artifact (if not cached)
        if: steps.cache-vllm-sim.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss. Building artifact..."
          docker build . -f tests/e2e/vllm-sim.Dockerfile -o type=local,dest=./
        shell: bash
      - name: Verify artifact
        run: |
          if [ -f "bin/llm-d-inference-sim" ]; then
            echo "Artifact found."
          else
            echo "ERROR: Artifact bin/llm-d-inference-sim not found!"
            exit 1
          fi
        shell: bash
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
      - name: Install dependencies
        run: |
          curl -sSL https://pdm-project.org/install-pdm.py | python3 -
          pip install tox tox-pdm
      - name: Run end-to-end tests
        run: tox -e test-e2e -- ${{ inputs.args }}
